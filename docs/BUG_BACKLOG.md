# Bug Backlog — QA Bug Bash (qa/bug-bash-100)

Generated: 2026-02-15
Method: Static code review across all packages (core, db, api, web) plus deployment config.
Total issues: 100

---

## Summary

| Priority | Count | Description |
|----------|-------|-------------|
| P0       | 8     | Ship blockers — crash, data loss, auth broken |
| P1       | 22    | High — gameplay wrong, economy wrong, major UI break |
| P2       | 44    | Medium — UI polish, confusing flows, security hardening |
| P3       | 26    | Low — minor copy, spacing, code quality |

---

## P0 — Ship Blockers

| # | Title | Steps to Reproduce | Expected | Actual | Suspected File(s) | Quick Fix |
|---|-------|--------------------|----------|--------|--------------------|-----------|
| 1 | Timezone silently dropped on registration — every player defaults to Asia/Dubai | Register a new account. Frontend sends `{ username, password, timezone }`. | Player's timezone stored in DB for daily-reset calculations. | `RegisterSchema` only has `username` and `password`; Zod strips unknown keys. DB default `Asia/Dubai` used for everyone. Daily reset, circadian multipliers, and meal tracking are wrong for all non-Dubai players. | `apps/api/src/schemas/auth.schemas.ts:3-17`, `apps/api/src/services/auth.service.ts:39-44,82` | Add `timezone: z.string().optional()` to `RegisterSchema`; pass through to `bootstrapPlayer()` INSERT. |
| 2 | Sleep regen formula uses wrong multiplier — sleepers get less regen than awake players at night | Start a SLEEP action at night (00:00–06:00). Compare PV regen to an awake player. | Sleeping PV regen should be higher (2.0 base × 2.0 night-sleep = 4.0/hr). | `applyHourlyVigorTick` in `vigor.ts:456-468` applies circadian night multiplier (0.5 for awake) THEN checks sleep. For sleeping players, `pvMultiplier` is already 0.5 from the night branch (used for awake penalty), then sleep branch overrides to 2.0 — but this only fixes PV. MV sleep multiplier (1.2) is applied on top of the 0.5 night multiplier, giving 0.6 instead of 1.2. | `packages/core/src/vigor.ts:456-480` | Apply sleep multipliers BEFORE circadian: if sleeping, skip the 0.5 night awake penalty entirely. |
| 3 | Failed SLEEP action permanently locks player in sleeping state | Submit SLEEP. Cause resolution failure (DB error, server crash mid-resolve). | Player returns to `awake` state. | `onSubmit` sets `sleep_state = 'sleeping'` in the submit transaction. If resolution fails, no code resets it. `checkPreconditions` blocks new sleep ("already sleeping"). Player is soft-locked permanently. | `apps/api/src/handlers/sleep.handler.ts:28-34`, `apps/api/src/services/action-engine.ts:282-318` | In the failure path of `resolveActionInTx`, if action type is SLEEP, reset `sleep_state = 'awake'` in the same transaction. |
| 4 | Non-atomic market order placement — double-spend via nested transactions | Place a buy order while another transaction is in progress for the same player. | Funds should be atomically checked and reserved. | `placeOrder` at `market-service.ts:290` opens its own `withTransaction` which creates a NEW connection from the pool, separate from the action engine's `ctx.tx`. The balance check at line 300 runs on the inner connection, not seeing uncommitted debits on the outer. Two concurrent orders can both pass the balance check and drain the player below zero. | `apps/api/src/services/market-service.ts:290-340` | Accept `tx: PoolClient` as a parameter; use the action engine's transaction instead of opening a new one. |
| 5 | Non-atomic market order cancellation — same nested transaction issue | Cancel an order while another action is resolving for the same player. | Cancellation should be atomic with the action engine transaction. | Same pattern as #4: `cancelOrder` opens its own `withTransaction`, creating a separate DB connection. Inventory refund and status update happen outside the action engine's transaction scope. | `apps/api/src/services/market-service.ts:370-420` | Accept `tx: PoolClient` as a parameter; use the caller's transaction. |
| 6 | Labor hours double-spend across concurrent production jobs | Business has 2 labor hours. Start production job A (needs 2 hrs). Before A completes, start job B. | Job B should fail — all labor committed. | Labor availability check only compares total effective labor vs. recipe requirement. Running jobs' committed labor hours are not subtracted. Unlimited concurrent jobs can start with the same labor pool. | `apps/api/src/services/business-service.ts:432-447` | Sum `labor_hours` from `status='running'` production jobs for the business and subtract from effective labor before checking. |
| 7 | `floorToTickWindow` uses local time, not UTC — duplicate or missed ticks | Run tick worker on a server with non-UTC timezone. | Tick windows computed in UTC for consistency. | `d.setHours()`, `d.getHours()` operate on local time. A server in UTC+4 creates daily tick at 20:00 UTC; a UTC server creates it at 00:00 UTC. UNIQUE constraint allows both — daily tick runs twice. Or if only one server, tick fires at wrong UTC time. | `apps/api/src/services/tick-service.ts:58-72` | Use `d.setUTCHours()`, `d.getUTCHours()`, `d.setUTCMinutes(0)`, `d.setUTCSeconds(0, 0)`. |
| 8 | Docker Compose prod exposes Postgres port 5432 to public internet | Deploy with `docker-compose.prod.yml`. | DB accessible only within Docker network. | `ports: - '5432:5432'` binds to `0.0.0.0:5432` on the host. Anyone on the internet can connect to the database with the credentials in the environment. | `docker-compose.prod.yml:10-11` | Remove the `ports:` section from the postgres service entirely. Containers connect via Docker network hostname. |

---

## P1 — High

| # | Title | Steps to Reproduce | Expected | Actual | Suspected File(s) | Quick Fix |
|---|-------|--------------------|----------|--------|--------------------|-----------|
| 9 | Double vigor regen during sleep — sleeping players accumulate both awake AND sleep regen | Start sleep at 22:00. Hourly tick fires at 23:00. | Only sleep-mode regen should apply. | Tick service calls `applyHourlyVigorTick` which first applies awake base regen (with circadian), then ALSO applies sleep regen bonuses on top. The sleep branch adds to already-calculated values instead of replacing them. | `packages/core/src/vigor.ts:456-490` | Make sleep and awake branches mutually exclusive — use `if/else` so sleep skips the awake regen path entirely. |
| 10 | Guest username collision at scale — 32-bit random space causes birthday-problem crashes | Create ~65,000 guest accounts (50% collision probability at 2^16). | Guest usernames unique. | `crypto.randomBytes(4)` = 32 bits of entropy. Collision causes raw Postgres unique-constraint violation (500 error) instead of a clean `ValidationError`. | `apps/api/src/services/auth.service.ts:119` | Use `crypto.randomBytes(12).toString('hex')` (96 bits). Catch unique constraint violation and retry. |
| 11 | clearCookie on logout uses incomplete options — cookie persists in production | Log in on HTTPS production, then log out. | `session_id` cookie removed. | `reply.clearCookie(SESSION_COOKIE, { path: '/' })` lacks `secure`, `sameSite`, `httpOnly`. Safari and mobile browsers refuse to overwrite a `Secure` cookie without matching attributes. Cookie persists, user appears logged in. | `apps/api/src/routes/auth.ts:81` | Use `reply.clearCookie(SESSION_COOKIE, sessionCookieOptions(isProduction))` to match all original attributes. |
| 12 | Inventory double-spend via concurrent startProduction calls | Business has 3 RAW_FOOD. Two concurrent `startProduction` calls for recipes needing 3 each. | Second call fails with InsufficientInventoryError. | Both SELECT inventory without `FOR UPDATE`. Both see qty=3. Both deduct. `GREATEST(0, 0 + (-3))` clamps to 0 silently. Second job proceeds with phantom inputs. | `apps/api/src/services/business-service.ts:461-466` | Add `FOR UPDATE` to inventory SELECT in `getInventoryQty`; remove `GREATEST(0,...)` and add CHECK constraint. |
| 13 | Rate limit check runs outside transaction — market order rate limit bypassable | Player at 9/10 orders per minute. Two concurrent requests arrive. | Only one should pass. | Rate limit query uses `queryOne(...)` (pool) not `txQueryOne(tx, ...)`. Both reads see count=9, both pass. Result: 11 orders in the minute. | `apps/api/src/handlers/market-place-order.handler.ts:76-87` | Change to `txQueryOne(tx, ...)` using `ctx.tx`. |
| 14 | Unpaid wages still count toward worker satisfaction | Set worker wage to 120 BCE. Let player wallet reach 0. Daily tick runs. | Satisfaction calculated from actually paid amount (0). | Wage payment silently skipped when `balance < worker.wage_cents`. Satisfaction update still uses configured `worker.wage_cents`. Player gets high satisfaction and labor output without paying. | `apps/api/src/services/business-service.ts:710-736` | Track whether wage was paid; pass actual paid amount (0 if skipped) to satisfaction calculation. |
| 15 | Failed tick never retried — permanently stuck | Daily tick fails (transient DB error). | Tick retried or recovery mechanism exists. | `failTick()` sets `status = 'failed'`. Worker only claims `status = 'pending'`. No retry, no alert. The entire daily cycle for all players is permanently skipped. Next iteration creates ticks only for current window. | `apps/api/src/services/tick-service.ts:124-130` | Add recovery: reset `'failed'` ticks older than N minutes back to `'pending'` with a max retry count. |
| 16 | Health check endpoint doesn't verify DB — container marked healthy when DB is down | Deploy with docker-compose.prod.yml. Stop the database. | Healthcheck fails; container marked unhealthy. | Docker healthcheck hits `/health` which returns `{ status: 'ok' }` without checking DB. The DB-checking endpoint is `/health/db`. Caddy routes traffic to an API that cannot serve requests. | `docker-compose.prod.yml:67`, `apps/api/src/routes/health.ts:6` | Change Docker healthcheck URL to `/health/db` or `/ready`. |
| 17 | Connection pool exhaustion — 3 processes × 20 connections = 60 against default Postgres 100 | Run API + scheduler + tick under moderate load. | Pool sizes tuned to total available connections. | Each process creates a pool with `max: 20`. Total: 60 connections. Postgres default `max_connections = 100` minus background workers leaves ~85 slots. Under load, all processes compete. No `max_connections` configured in Docker Compose. | `packages/db/src/index.ts:11`, `docker-compose.prod.yml` | Reduce worker pool to `max: 5`; set explicit `max_connections` on Postgres. |
| 18 | TOCTOU race in idempotency check — checked outside transaction | Send two simultaneous identical POST /actions with same idempotency key. | Exactly one action created. | Idempotency check at `action-engine.ts:132-148` runs OUTSIDE the transaction. Both requests pass the check, both insert. Either duplicate or raw Postgres error (500). | `apps/api/src/services/action-engine.ts:132-148` | Move idempotency check inside the transaction; or catch unique constraint violation and return cached result. |
| 19 | Missing wallet (playerAccountId=0) makes meals free | Create player without `player_wallets` entry. Submit EAT_MEAL. | Error indicating missing wallet. | `playerAccountId` defaults to 0. `eat-meal.handler.ts:48`: `if (costCents > 0 && ctx.playerAccountId > 0)` skips balance check and payment entirely. Meal is free. | `apps/api/src/services/action-engine.ts:257-262`, `apps/api/src/handlers/eat-meal.handler.ts:48` | Throw `ValidationError('Player wallet not found')` if wallet is null before proceeding to handler. |
| 20 | Handlers don't round vigor — fractional values written to integer DB columns | Any regen or buff that produces fractional values (e.g., SpV 0.3/hr). Then action handler reads and writes raw float. | Vigor values stored as integers (matching schema). | Tick service rounds with `Math.round()` but action handlers write raw `newVigor.pv`, `newVigor.mv` without rounding. Fractional values accumulate. | All handler files: `eat-meal.handler.ts`, `leisure.handler.ts`, `social-call.handler.ts`, `work-shift.handler.ts`, `sleep.handler.ts` | Wrap all vigor values in `Math.round()` before DB write in each handler. |
| 21 | Daily reset timer stuck at zero — never re-renders after countdown expires | Watch the timer on any game page. Wait for it to reach 0. | Timer resets to show next day's countdown. | `daily-reset-timer.tsx` computes `secondsLeft` from server's snapshot `secondsUntilDailyReset` minus elapsed time since mount. No `setInterval` forces re-render — React has no reason to re-render after reaching 0. Timer freezes at `0h 00m 00s`. | `apps/web/src/components/daily-reset-timer.tsx:5-15` | Add `useEffect` with `setInterval(() => setTick(t => t+1), 1000)` to force periodic re-renders. |
| 22 | Stale vigor displayed after returning to tab — no refetch on window focus | Open game, switch to another tab for 30 minutes. Return. | Vigor values refresh immediately. | `QueryClient` in `providers.tsx:9` sets `refetchOnWindowFocus: false`. Vigor (polling every 60s) continues from the last poll time. User sees 30-minute-old data until the next poll cycle. | `apps/web/src/components/providers.tsx:9` | Change to `refetchOnWindowFocus: true` for player state queries, or set it globally. |
| 23 | Double-submit race after mutation success | On Food page, click "Go" on a meal. After success, quickly click again before refetch completes. | Button disabled until state fully refreshed. | `useSubmitAction` sets `isPending=false` on mutation resolve, then asynchronously calls `invalidateQueries`. Buttons re-enable with stale data between mutation success and refetch completion. | `apps/web/src/hooks/use-submit-action.ts:29-31` | Use `await queryClient.invalidateQueries(...)` in onSuccess; or use optimistic updates via `onMutate`. |
| 24 | No CSRF protection on cookie-authenticated routes | Attacker site embeds `<form method="POST" action="https://api.example.com/actions">`. | State-mutating requests protected by CSRF token. | No CSRF mechanism exists. `sameSite: 'lax'` blocks most cross-origin sub-requests but not top-level form POST navigations in some browsers. GET endpoint `/me/state` has side effects (`resolveAllDue`). | `apps/api/src/plugins/auth.ts:14-66` | Implement double-submit cookie pattern: set non-httpOnly CSRF cookie on login; require `X-CSRF-Token` header. |
| 25 | Matching engine breaks on insufficient funds instead of continuing to cheaper orders | Buy market order for 100 units. Best sell is 50@100c, next is 50@90c. Player can afford 50@100c but not another 50@100c. | Engine tries next (cheaper) order. | `break` at `market-service.ts:452-458` exits the matching loop entirely. Cheaper orders further down the book that the buyer could afford are never evaluated. | `apps/api/src/services/market-service.ts:452-458` | Replace `break` with logic to calculate max affordable qty at the current price, or `continue` to try next order. |
| 26 | Buy limit orders create phantom liquidity — no fund reservation | Place buy limit order for 1000c. Spend funds on other actions. Seller tries to fill. | Funds escrowed at order placement. | Only a point-in-time balance check at placement. No funds locked. Resting buy orders may represent more buying power than the player has. Matches fail and orders pollute the book. | `apps/api/src/services/market-service.ts:300-308` | Implement fund escrow via MARKET_ESCROW system account (ID 3, already defined but unused). |
| 27 | `dotenv.config()` called after DB module initialization — hidden dependency | Run API with `DATABASE_URL` only in `.env` file. | `.env` loaded before pool reads `DATABASE_URL`. | `apps/api/src/index.ts` imports `@blueth/db` (line 6) before calling `dotenv.config()` (line 19). Works only because db module has its own `dotenv.config()`. If db removes it, API silently uses fallback dev connection string in production. | `apps/api/src/index.ts:6,19` | Move `dotenv.config()` to the very first line of `index.ts`, before any imports. |
| 28 | O(N) balance calculation via full ledger scan on every balance check | Any balance check (order placement, matching loop, daily tick). Player has thousands of ledger entries. | O(1) balance lookup. | `getAccountBalance()` scans all `ledger_entries` with `WHERE from_account = $1 OR to_account = $1`. In matching engine loop, called per fill. In daily tick, called per player. Degrades severely as ledger grows. | `packages/db/src/index.ts:82`, `apps/api/src/services/market-service.ts:161-173` | Maintain a `balance_cents` column on `ledger_accounts` updated atomically with each entry. |
| 29 | Middleware blocks all `/_next/static` assets when session cookie missing — PWA offline broken | Install PWA. Clear cookies. Open app offline. | Static assets served from cache/CDN without auth check. | Middleware at `middleware.ts:21-27` checks for `session_id` cookie on ALL requests (except paths excluded by matcher). `/_next/static` is excluded by matcher regex, but `/_next/data` is NOT. Dynamic route data fetches are blocked, causing hydration failures. | `apps/web/src/middleware.ts:19-27,32-34` | Add `/_next/data` to the matcher exclusion, or check authentication only for page routes. |
| 30 | Logout in ITCH_MODE strands user on blank screen | In ITCH_MODE: authenticate as guest, navigate to game page, log out. | RequireAuth redirects to `/login`. | `hasRedirected.current` is already `true` and never resets. Logout doesn't do full page reload in ITCH_MODE. Status transitions to `unauthenticated` but RequireAuth renders `null` silently. | `apps/web/src/components/require-auth.tsx:21,34` | Reset `hasRedirected.current = false` when status transitions from `authenticated`. |

---

## P2 — Medium

| # | Title | Steps to Reproduce | Expected | Actual | Suspected File(s) | Quick Fix |
|---|-------|--------------------|----------|--------|--------------------|-----------|
| 31 | No precondition recheck at resolution time for scheduled actions | Queue LEISURE then WORK_SHIFT. Work shift depletes vigor to 0. LEISURE resolves. | LEISURE resolution rechecks vigor and fails gracefully. | `resolveActionInTx` does NOT call `handler.checkPreconditions()` before `resolve()`. Preconditions only checked at submit time. Hours may pass; state can change drastically. | `apps/api/src/services/action-engine.ts:266` | Add `handler.checkPreconditions(payload, lockedState)` before `handler.resolve()` in `resolveActionInTx`. |
| 32 | Leisure and social-call handlers don't check sleep state | Submit SLEEP. While sleeping, submit LEISURE or SOCIAL_CALL. | Rejected with "Cannot do while sleeping". | Only `validateNoHardLockouts` is called (checks zero-vigor), never checks `sleep_state`. Work-shift handler checks it; these two don't. Sleeping player can queue activities. | `apps/api/src/handlers/leisure.handler.ts:23`, `social-call.handler.ts:22` | Add `if (state.sleep_state !== 'awake') throw new ActionConflictError(...)` to both `checkPreconditions`. |
| 33 | Idempotency check doesn't verify payload — returns wrong cached result | Submit EAT_MEAL with `quality: 'STREET_FOOD'` and key `"meal-1"`. Submit again with `quality: 'FINE_DINING'` and key `"meal-1"`. | Error or rejection for mismatched payload. | Only `existing.type !== type` checked. Payload not compared. Second request returns first's cached result (STREET_FOOD). Player intended FINE_DINING but sees wrong data. | `apps/api/src/services/action-engine.ts:138` | Add payload hash comparison. |
| 34 | Preview shows no vigor gain for most meal types | Preview EAT_MEAL with `quality: 'STREET_FOOD'`. | Shows projected buff benefit. | Only `mealDef.instantDelta` used for `vigorGain`. STREET_FOOD, HOME_COOKED, NUTRIENT_OPTIMAL have no `instantDelta` — all benefit is from per-hour buffs. Preview shows zero change, making meals look worthless. | `apps/api/src/routes/actions.ts:101-109` | Compute estimated total: `(perHourBonus * durationHours) + instantDelta` per dimension. |
| 35 | Preview endpoint doesn't validate payload or check preconditions | Preview SLEEP with `{ hours: 100 }` or preview WORK_SHIFT while sleeping. | Preview returns error or flags as impossible. | Only outer `SubmitActionSchema` parsed. Never calls `handler.validatePayload()` or `handler.checkPreconditions()`. Invalid/impossible actions return projections as if they'd succeed. | `apps/api/src/routes/actions.ts:68-75` | Call `handler.validatePayload(payload)` and `handler.checkPreconditions(payload, state)` after parsing. |
| 36 | Meal payment sent to wrong system account | Buy any meal. Check ledger. | Payment goes to NPC_VENDOR (account 5). | `eat-meal.handler.ts:69` sends to `SYSTEM_ACCOUNTS.BILL_PAYMENT_SINK` (account 4). Economy module's `createPurchaseEntry` routes purchases to NPC_VENDOR. Meal purchases pollute the wrong sink. | `apps/api/src/handlers/eat-meal.handler.ts:69` | Change to `SYSTEM_ACCOUNTS.NPC_VENDOR`. |
| 37 | Waste disposal fee silently skipped when business can't pay | Business account has 0 balance. Production job completes with WASTE output. | Fee charged, deferred as debt, or job blocked. | Balance check fails silently. Comment says "fee deferred" but no deferral mechanism. Waste inventory produced, outputs delivered, fee never charged. Infinite free waste disposal. | `apps/api/src/services/business-service.ts:574-588` | Record unpaid fee as deferred liability, or deduct from player's personal wallet. |
| 38 | Deterministic cancel idempotency key prevents retry after transient failure | Cancel market order. Transient error occurs after key recorded but before cancellation completes. Retry. | Retry succeeds. | Key = `'cancel-${orderId}'`. After partial failure, same key is permanently used. Player can never cancel this order again. | `apps/api/src/routes/market.ts:106` | Use client-provided idempotency key instead of deriving from order ID. |
| 39 | No maximum order quantity validation | Place buy order with `qty: 999999999`. | Rejected with reasonable max. | Schema only checks `z.number().positive()`. Massive orders drain all NPC liquidity in one trade. | `apps/api/src/routes/market.ts:66`, `apps/api/src/handlers/market-place-order.handler.ts:38` | Add `.max(10000)` to qty schema. |
| 40 | Fractional order quantities cause floating-point dust in matching | Place buy order with `qty: 1.1`. | Integer-only quantities or exact decimal math. | `parseFloat` for quantities and `0.000001` epsilon comparisons for fill completion. IEEE 754 dust accumulates. Orphaned partial orders with dust quantities pollute order book. | `apps/api/src/services/market-service.ts:392,513,521,536` | Enforce integer quantities: `z.number().int().positive()`. |
| 41 | Unlimited $0-wage workers exploit | Hire 100 workers at $0 wage. Start production immediately. | Minimum wage or worker cap enforced. | `wageCents: z.number().int().min(0)` allows $0. All workers start at satisfaction 1.0. Massive labor output for zero cost on day 1. | `apps/api/src/routes/business.ts:177`, `apps/api/src/services/business-service.ts:352-383` | Enforce minimum wage `min(1000)` or cap workers per business. |
| 42 | GREATEST(0,...) in adjustInventory silently hides bugs | Any concurrent access bug attempts to subtract more than exists. | Error thrown to catch the bug. | `GREATEST(0, qty + delta)` clamps to 0 silently. Items destroyed without error or audit. Masks bugs like #12. | `apps/api/src/services/market-service.ts:200-207`, `business-service.ts:165-180` | Add `CHECK (qty >= 0)` constraint; remove `GREATEST(0,...)`; let constraint throw on genuine double-deduct. |
| 43 | Social call and leisure have no vigor cost — unlimited free vigor farming | Queue 12 SOCIAL_CALL actions (15 min each). Result: SV +36, MV +12 for free. | Some vigor cost or cooldown prevents farming. | Neither handler deducts any vigor or money. Queue size (12) provides some throttle but +36 SV and +12 MV is very strong for zero investment. | `apps/api/src/handlers/social-call.handler.ts`, `leisure.handler.ts` | Add vigor costs (e.g., social call: pv: 2; leisure: pv: 3, mv: 1) or daily limits. |
| 44 | No recovery for actions stuck in 'running' state after crash | Kill server while action is in `resolveActionInTx`. | Action recovers after server restart. | If server crashes between COMMIT of 'running' status and completion, action stays 'running' forever. `resolveAllDue` only filters `status = 'scheduled'`. | `apps/api/src/services/action-engine.ts:251,327` | Add timeout recovery: `AND (status = 'scheduled' OR (status = 'running' AND started_at < NOW() - interval '5 minutes'))`. |
| 45 | Non-UUID cookie value causes 500 error | Set `session_id` cookie to `abc123`. | Clean 401 response. | Query tries to cast to UUID. PostgreSQL throws `invalid input syntax for type uuid` which becomes 500. | `apps/api/src/plugins/auth.ts:28-34` | Validate UUID format before querying: `if (!/^[0-9a-f-]{36}$/i.test(sessionId)) return;` |
| 46 | Race condition on username uniqueness in registration | Two users register with same username concurrently. | One succeeds, other gets clean `ValidationError`. | Both pass `SELECT` existence check. Second INSERT hits unique constraint → raw 500 error. | `apps/api/src/services/auth.service.ts:86-95` | Catch Postgres error code 23505 and convert to `ValidationError`. |
| 47 | CORS allows null/missing origins in production | Request from `file://` URI or sandboxed iframe. | Only explicitly allowed origins permitted. | `if (!origin) return cb(null, true)` passes through any request without Origin header. | `apps/api/src/index.ts:44` | Change to `if (!origin) return cb(null, false)`. |
| 48 | Auth plugin public-path check is prefix-based — overly permissive | Register a route at `/healthadmin`. | Route requires authentication. | `request.url.startsWith('/health')` makes it public. Any URL starting with `/health`, `/auth`, or `/ready` bypasses auth. | `apps/api/src/plugins/auth.ts:23` | Use exact matches with boundary check: `request.url === p \|\| request.url.startsWith(p + '/')`. |
| 49 | `resetToken` endpoint doesn't verify caller is a guest | Log in as registered user. Call `POST /me/token-reset`. | Rejected for non-guest players. | Creates a new `guest_tokens` row for registered player, granting 30-day bearer token alongside session cookie. | `apps/api/src/routes/player.ts:25`, `apps/api/src/services/guest-token.service.ts:18` | Check if player is a guest before issuing token. Return 403 if not. |
| 50 | No session/token cleanup — expired rows accumulate unboundedly | Run app for weeks/months. | Periodic cleanup of expired sessions/tokens. | No DELETE of expired sessions or tokens anywhere. Tables grow without bound. | System-wide gap | Add scheduled task in scheduler worker: `DELETE FROM sessions WHERE expires_at < NOW()`. |
| 51 | Login doesn't invalidate old sessions — session fixation risk | User has old session. Logs in again. Old session still valid. | Old sessions deleted on new login. | New session created without deleting previous ones. Old session_id remains valid for attacker who obtained it. | `apps/api/src/services/auth.service.ts:160-167` | Before creating new session: `DELETE FROM sessions WHERE player_id = $1`. |
| 52 | Guest auto-login race with initial query in ITCH_MODE | Visit app first time in ITCH_MODE. | Player state query succeeds after guest creation. | `useEffect` fires `guestLogin()` async. `useQuery` for `/me/state` already fired with no token → 401. With `retry: false`, query fails permanently. `invalidateQueries` may not re-trigger errored query. | `apps/web/src/lib/auth-context.tsx:65-98` | Add `enabled: !ITCH_MODE \|\| !!localStorage.getItem('guest_token')` to query options. |
| 53 | No React Error Boundary — render error crashes entire app | Any runtime error during React render. | Graceful fallback UI with recovery options. | No `ErrorBoundary` anywhere in the component tree. Single thrown error unmounts entire app → white screen. | `apps/web/src/app/layout.tsx`, `apps/web/src/app/(game)/layout.tsx` | Wrap main content in `ErrorBoundary` from `react-error-boundary`. |
| 54 | Service worker cache-first strategy serves stale code after deploy | Deploy new version. Revisit in browser with old SW. | User gets new version quickly. | `CACHE_NAME = 'blueth-v1'` is hardcoded. Cache-first strategy serves old JS/CSS indefinitely. No cache-busting. | `apps/web/public/sw.js:9,46-58` | Append build hash to `CACHE_NAME` or switch to stale-while-revalidate. |
| 55 | Mobile bottom nav shows only 5 of 11 pages — 6 pages undiscoverable | On mobile viewport, look at bottom nav. | All pages accessible or clear "More" button. | `NAV_ITEMS.slice(0, 5)` shows only 5 items. Food, Leisure, Market, Business, Summary, Settings only in hamburger menu that many users never discover. | `apps/web/src/components/game-shell.tsx:162` | Replace last slot with "More" icon that opens hamburger drawer. |
| 56 | `useSubmitAction` doesn't invalidate market/business queries | Place market order. Switch to Business page. | Market/business data refreshed. | `onSuccess` only invalidates `queryKeys.player.all` and `queryKeys.actions.all`. Market/business queries not refetched → stale data. | `apps/web/src/hooks/use-submit-action.ts:29-31` | Also invalidate `queryKeys.market.all` and `queryKeys.business.all`. |
| 57 | PWA manifest has SVG-only icons — older platforms require PNG | Install PWA on older Android (< 12) or desktop Chrome. | Install prompt shows proper icons. | Only `image/svg+xml` icons declared. No `maskable` purpose. Older platforms need PNG. | `apps/web/public/manifest.json:11-24` | Add 192x192 and 512x512 PNG icons; add `maskable` purpose icon. |
| 58 | City map SVG polygons have no accessibility | Navigate City Map with screen reader or keyboard. | Districts focusable and announced. | `<polygon>` elements have no `role="button"`, `aria-label`, `tabIndex`, or keyboard handlers. Map inaccessible to non-mouse users. | `apps/web/src/components/city-map.tsx:30-41` | Add `role="button"`, `tabIndex={0}`, `aria-label={d.name}`, `onKeyDown` handler. |
| 59 | Mobile hamburger menu has no ARIA label or expanded state | Focus hamburger button with screen reader. | Announces "Toggle menu" and expanded state. | Button has no `aria-label` or `aria-expanded`. Screen readers announce just "button". | `apps/web/src/components/game-shell.tsx:57-62` | Add `aria-label="Toggle navigation menu"` and `aria-expanded={mobileOpen}`. |
| 60 | Mobile sidebar overlay doesn't trap focus | Open hamburger menu, press Tab repeatedly. | Focus stays within sidebar. | Simple conditionally rendered div with no focus trap. Users Tab to elements behind overlay. | `apps/web/src/components/game-shell.tsx:127-151` | Use focus trap library like `@radix-ui/react-dialog` or `focus-trap-react`. |
| 61 | Login/Register forms missing `autocomplete` attributes | Open login page with password manager enabled. | Password manager identifies fields. | No `autocomplete` attributes on username/password inputs. Password managers may not populate correctly. | `apps/web/src/app/login/page.tsx:56-71`, `register/page.tsx:69-95` | Add `autoComplete="username"` and `autoComplete="current-password"` / `autoComplete="new-password"`. |
| 62 | DailyResetTimer shows fractional seconds | Server returns `secondsUntilDailyReset: 3600.7`. | Seconds displayed as whole number. | `const s = totalSeconds % 60` produces `0.7`. Display reads `0.7s`. | `apps/web/src/components/daily-reset-timer.tsx:10` | Use `Math.floor(totalSeconds)` at start of function. |
| 63 | ActionCard displays `-undefined` for partial vigor costs | Pass `vigorCost` with some undefined values. | Only defined costs displayed. | `Object.entries(vigorCost)` includes undefined values. Badge renders `-undefined`. | `apps/web/src/components/action-card.tsx:59` | Filter: `Object.entries(vigorCost).filter(([, val]) => val != null)`. |
| 64 | VigorBar shows NaN% width if vigor value is undefined | Server returns undefined for a vigor dimension. | Bar renders at 0%. | `Math.min((undefined / cap) * 100, 100)` = `NaN`. CSS `width: NaN%` is invalid. | `apps/web/src/components/vigor-bar.tsx:16` | `const pct = cap > 0 ? Math.max(0, Math.min(((value ?? 0) / cap) * 100, 100)) : 0;` |
| 65 | Login via username/password doesn't work in ITCH_MODE | Set `NEXT_PUBLIC_API_URL`. Go to `/login`. Submit credentials. | Login succeeds. | Cross-origin `Set-Cookie` blocked by SameSite policy. Login function doesn't store token from response (unlike `guestLogin`). Session lost immediately. | `apps/web/src/lib/auth-context.tsx:100-103` | Capture response token and store in `localStorage` like `guestLogin`. |
| 66 | `useActionPreview` uses POST in useQuery — POST re-fires on refetch | Page with preview open. Background refetch fires. | Preview uses GET semantics. | `api.post` inside `useQuery.queryFn`. TanStack Query re-fires POST on stale refetches. Semantically incorrect usage. | `apps/web/src/hooks/use-action-preview.ts:31-36` | Change API to GET with query params, or accept the semantic mismatch with documentation. |
| 67 | MEAL_PRICES_CENTS hardcoded on client — may diverge from server | Server updates meal prices. | UI shows correct prices. | `constants.ts:43-49` hardcodes prices. "Not enough money" check uses client constant. May not match server's actual charge. | `apps/web/src/lib/constants.ts:43-49` | Fetch from server or import from `@blueth/core`. |
| 68 | BusinessPage shows no error state when fetch fails | Network error on `/business` endpoint. | Error message with retry button. | Only `isLoading` checked. On error: `businesses` is undefined, `items` is `[]`, page says "Register your first business" — misleading. | `apps/web/src/app/(game)/business/page.tsx:11-19` | Destructure `isError`; show error message if true. |
| 69 | `withTransaction` swallows rollback errors | Transaction callback throws. Then ROLLBACK itself fails (connection terminated). | Original error preserved; rollback failure logged. | If `ROLLBACK` throws, that error replaces the original. Caller gets misleading "connection terminated" instead of real domain error. | `packages/db/src/index.ts:59-74` | Wrap ROLLBACK in try-catch, log rollback error, re-throw original. |
| 70 | Caddy doesn't wait for web service health | `docker compose up`. Caddy starts when API is healthy but web is still starting. | Caddy waits for both API and web. | Caddy `depends_on` only checks `api`. Requests to web domain get 502 until Next.js starts. | `docker-compose.prod.yml:161-182` | Add `web: condition: service_healthy` to Caddy `depends_on`. |
| 71 | Scheduler retry_count never incremented — dead retry logic | Action fails resolution. Check retry_count. | retry_count incremented; action retried up to 3 times. | Catch block sets `status = 'failed'`, never increments `retry_count`. The `retry_count < 3` filter in claim query is dead code. Actions fail permanently on first error. | `apps/api/src/services/scheduler-service.ts:37,84-93` | Either implement actual retry (set `status='scheduled'`, increment retry_count) or remove the filter. |
| 72 | Permanently stuck scheduled actions after 3 retries (if retry were implemented) | Action reaches `retry_count >= 3`. | Marked as permanently failed. | If retry were implemented, actions with `retry_count >= 3` stay in `scheduled` status forever — not claimable (filtered out) but not marked failed either. | `apps/api/src/services/scheduler-service.ts:37` | Add cleanup pass that marks `retry_count >= 3` as `'permanently_failed'`. |
| 73 | FOR UPDATE in daily tick uses pool query — lock is useless | Daily tick processes business workers. | FOR UPDATE prevents concurrent modification during wage loop. | `query(...)` from pool module runs in auto-commit. Row lock acquired and immediately released within single statement. No protection against concurrent modification. | `apps/api/src/services/business-service.ts:703-705` | Replace `query(...)` with `tx.query(...)`. |
| 74 | Worker query in startProduction uses pool instead of transaction | Concurrent daily tick fires while production starts. | Transactionally consistent worker data. | `query<BusinessWorkerRow>(...)` uses pool instead of `tx.query(...)` despite receiving `tx` parameter. Reads potentially stale data. | `apps/api/src/services/business-service.ts:432-434` | Replace with `tx.query(...)`. |

---

## P3 — Low

| # | Title | Steps to Reproduce | Expected | Actual | Suspected File(s) | Quick Fix |
|---|-------|--------------------|----------|--------|--------------------|-----------|
| 75 | Username enumeration via distinct registration error | POST `/auth/register` with existing username. | Generic "Registration failed" message. | Response: `Username "admin" is already taken` — confirms user exists. | `apps/api/src/services/auth.service.ts:92` | Use generic message: "Registration failed. Username may already be taken." |
| 76 | Guest token in localStorage vulnerable to XSS | XSS vulnerability allows JS to read `localStorage.getItem('guest_token')`. | Token in httpOnly cookie. | Raw bearer token in localStorage accessible to any JS. | `apps/web/src/lib/auth-context.tsx:79`, `api.ts:17-19` | Consider httpOnly cookie via API. At minimum, enforce CSP headers. |
| 77 | SQL INTERVAL built via string interpolation — latent injection risk | Currently unexploitable (hardcoded constants). If constants become env vars, becomes SQL injection. | Duration parameterized safely. | `INTERVAL '${SESSION_DURATION_DAYS} days'` in 4 places. | `apps/api/src/services/auth.service.ts:100,129,163`, `guest-token.service.ts:26` | Use `$2 * INTERVAL '1 day'` with parameterized value. |
| 78 | Buff ID generation uses module-level counter — not unique across instances | Two API instances create meal buffs simultaneously. | Globally unique buff IDs. | `nextBuffId()` uses `Date.now()` + process-local counter. Two instances can generate identical IDs in same millisecond. | `packages/core/src/vigor.ts:598-602` | Use `crypto.randomUUID()`. |
| 79 | 'exhausted' sleep state is a permanent lockout — no recovery path | Player state set to `sleep_state = 'exhausted'`. | Player can recover. | Schema includes `'exhausted'` but no handler sets it and no handler transitions out of it. Sleep blocked (`checkPreconditions` requires `awake`). No other action resets to `awake`. | `packages/core/src/types.ts:30`, `apps/api/src/handlers/sleep.handler.ts:23` | Remove `'exhausted'` from enum or add recovery path. |
| 80 | Action handlers don't update `updated_at` column | Eat meal, do leisure, work shift, etc. Check `updated_at`. | Reflects time of latest state change. | Tick service writes `updated_at = NOW()` but no action handler does. Clients relying on `updated_at` for staleness see stale timestamps. | All handler UPDATE queries | Add `updated_at = NOW()` to each handler's UPDATE. |
| 81 | SubmitActionSchema doesn't validate type against known values | POST `/actions` with `{ type: "NONEXISTENT" }`. | Zod validation error listing valid types. | Accepts any non-empty string. Only fails deeper in handler registry with generic "Unknown action type". | `apps/api/src/schemas/action.schemas.ts:8` | Change to `z.enum(Object.values(ACTION_TYPES))`. |
| 82 | LoginSchema allows arbitrarily long username and password | POST `/auth/login` with 1MB username string. | Consistent max-length validation. | `LoginSchema` only `.min(1)` with no `.max()`. 1MB string reaches bcrypt and DB query. | `apps/api/src/schemas/auth.schemas.ts:21-24` | Add `.max(50)` for username and `.max(128)` for password. |
| 83 | Bcrypt hash of random UUID for guest password wastes ~250ms CPU | POST `/auth/guest`. | Minimal CPU for unused field. | `bcrypt.hash(crypto.randomUUID(), 12)` runs for ~250ms on every guest creation. Hash is never checked. | `apps/api/src/services/auth.service.ts:121` | Use sentinel placeholder `'!guest_no_password'` as `password_hash`. |
| 84 | Session cookie not signed — relies solely on UUID unguessability | Cookie contains raw UUID. | Cookies signed with HMAC. | `@fastify/cookie` registered with empty `parseOptions` and no `secret`. Security depends on UUID v4 entropy. | `apps/api/src/plugins/auth.ts:15-17` | Pass `secret` to cookie plugin; use `signed: true`. |
| 85 | Logout doesn't verify session ownership | Craft request with another user's session UUID in cookie. | Only deletes sessions owned by authenticated user. | Endpoint is public (under `/auth` prefix). Blindly deletes session by ID regardless of owner. Attacker who knows UUID can force-logout any user. | `apps/api/src/routes/auth.ts:76-82` | Add WHERE clause: `DELETE FROM sessions WHERE id = $1 AND player_id = $2`. |
| 86 | No guest-to-registered upgrade path — guests lose all progress | Guest accumulates progress. Wants to set username/password and keep account. | Endpoint like `POST /me/claim` to upgrade. | No such endpoint exists. Guest must abandon account and register fresh. | System-wide gap | Add `POST /me/claim` route to update username/password on existing player record. |
| 87 | CV dimension comment says "Creative" but system treats it as "Civic" | Read code comments in `types.ts` vs. `vigor.ts` and `economy.ts`. | Consistent naming. | `types.ts:11` says "Creative Vigor". `vigor.ts:72` says "Civic burnout". `soft-gates.ts` describes CV as "Admin fees". | `packages/core/src/types.ts:11` | Change comment to `// Civic Vigor`. |
| 88 | Meal penalty escalation identical (+1) for 0, 1, or 2 meals | Day 1: eat 0 meals. Day 2: eat 2 meals. Compare penalty. | 0 meals escalates faster than 2. | All three branches increment `mealPenaltyLevel` by +1. Same escalation rate regardless of how many meals eaten. | `packages/core/src/vigor.ts:531-543` | Use graduated escalation: 0 meals = +3, 1 = +2, 2 = +1. |
| 89 | Sleep preview regen estimate ignores sleep-specific bonuses | Preview SLEEP at nighttime. | Shows enhanced night-sleep regen. | Hardcoded flat base rates: `pv: 2*hours`. Doesn't factor circadian, sleep multipliers, buffs, or penalties. | `apps/api/src/routes/actions.ts:93-98` | Use `applyHourlyVigorTick` simulation or document as approximation. |
| 90 | Preview for LEISURE omits ongoing buff effect | Preview LEISURE action. | Shows total gain including buff. | Only instant delta `{ mv: 4, spv: 2 }` shown. Buff (`mv: 1/hr * 3h = 3`, `spv: 0.5/hr * 3h = 1.5`) omitted. | `apps/api/src/routes/actions.ts:131-135` | Add buff regen to preview estimate. |
| 91 | Market fee comment contradicts implementation | Read market-service.ts matching code. | Accurate comments. | Comment says "split: buyer pays fee, seller pays fee". Only buyer pays fee. | `apps/api/src/services/market-service.ts:431` | Fix comment to "buyer pays full fee". |
| 92 | `parseBlueth` rejects negative plain numbers without currency symbol | Call `parseBlueth("-5.00")`. | Returns -500. | Regex `^-?₿` requires `₿`. Without it, `-5.00` produces `wholePart = "-5"` which fails digits-only check. | `packages/core/src/money.ts:110-131` | Change regex to `^-?₿?` to handle currency-symbol-free negative case. |
| 93 | In-memory metrics never flushed or exposed | Run workers for hours. | Metrics logged or queryable for monitoring. | `createMetrics()` returns a Map that grows without bound. Data never logged, never reset, never exposed. Worker health completely invisible. | `apps/api/src/services/observability.ts:76-97` | Add periodic log of counters (every 60s) and/or expose on HTTP endpoint. |
| 94 | PM2 logs sent to /dev/null — no crash forensics | Worker crashes. Check PM2 logs. | Crash logs available. | Both `out_file` and `error_file` set to `/dev/null`. If PM2 is not under systemd with journal forwarding, all logs permanently lost. | `ecosystem.config.cjs:25-26,35-36,49-50` | Remove `out_file`/`error_file` to let PM2 use default log location. |
| 95 | Caddy config missing request size limits and compression | Send 100MB POST to API domain. | Oversized request rejected; responses compressed. | No `request_body { max_size }`, no `encode gzip`, no security headers. Caddy buffers entire body before forwarding. | `Caddyfile` | Add `request_body { max_size 2MB }` and `encode gzip` to each site block. |
| 96 | Migration has no advisory lock — concurrent runs can corrupt | Two deployments start simultaneously running migrations. | Only one runner executes at a time. | No `pg_advisory_lock`. Both runners read same pending list, both apply same migrations. INSERT UNIQUE on `_migrations` fails for second, but DDL may have partially executed. | `packages/db/src/migrate.ts:66-106` | Add `SELECT pg_advisory_lock(12345)` at start, unlock in finally. |
| 97 | `validateConfig` uses `process.exit(1)` — untestable | Unit test calls `validateConfig()` without DATABASE_URL. | Should throw catchable error. | Calls `process.exit(1)` directly, terminating test runner. | `apps/api/src/config.ts:57` | Throw a `ConfigError` instead. Let entry point decide to exit. |
| 98 | Error handler leaks internal messages for non-domain 4xx errors | Unexpected 4xx error (not DomainError). | Generic error message. | `statusCode >= 500 ? 'Internal Server Error' : error.message` exposes raw message for 4xx. Could leak DB column names, paths. | `apps/api/src/plugins/error-handler.ts:29` | Use generic message for all unexpected (non-DomainError) errors. |
| 99 | Double safe-area padding on iPhone — body and bottom nav both pad | Open on iPhone with home indicator. | Single safe-area padding. | `globals.css:40` adds `padding-bottom: env(safe-area-inset-bottom)` to body. Bottom nav also adds it. Double padding pushes content up. | `apps/web/src/app/globals.css:40`, `game-shell.tsx:160` | Remove body padding; let only bottom nav handle safe area. |
| 100 | No per-page `<title>` — browser tab always says "Blueth City" | Navigate between pages. Check tab title. | Title reflects current page (e.g., "Jobs - Blueth City"). | No page exports `metadata` or `generateMetadata`. Root layout title always used. Poor multi-tab usability. | All `apps/web/src/app/(game)/*/page.tsx` | Add `export const metadata` to each page, or use Next.js `template`. |

---

## Cross-Reference: Issues by Area

| Area | Issue Numbers |
|------|---------------|
| **Auth / Sessions** | 1, 10, 11, 24, 30, 45, 46, 47, 48, 49, 50, 51, 52, 65, 75, 76, 77, 82, 83, 84, 85, 86 |
| **Vigor / Regen** | 2, 3, 9, 20, 21, 31, 32, 43, 78, 79, 80, 87, 88 |
| **Action Engine** | 18, 23, 33, 34, 35, 44, 71, 72, 81 |
| **Market / Economy** | 4, 5, 13, 25, 26, 28, 36, 38, 39, 40, 42, 91, 92 |
| **Business** | 6, 12, 14, 37, 41, 73, 74 |
| **Frontend UI / UX** | 22, 29, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 66, 67, 68, 89, 90, 99, 100 |
| **Infrastructure / Deploy** | 7, 8, 15, 16, 17, 27, 69, 70, 93, 94, 95, 96, 97, 98 |
